<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <%- include('partials/head') %>
  <title>سجل الطالب الشامل</title>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .search-section {
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      border: 2px solid rgba(0, 0, 0, 0.2);
      margin-bottom: 25px;
    }

    .student-info-card {
      background-color: #fff;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .stats-card {
      background: white;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stats-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .stats-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
      color: #000;
    }

    .stats-label {
      color: #000;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .stats-icon {
      font-size: 1.5rem;
      color: #000;
      margin-bottom: 10px;
    }

    .form-control,
    .form-select {
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 10px 15px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background-color: #fff;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: rgba(0, 0, 0, 0.5);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .btn {
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, #000 0%, #444 100%);
      border: none;
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(120deg, #111 0%, #555 100%);
      color: white;
    }

    .btn-secondary {
      background-color: #fff;
      color: #000;
      border: 2px solid rgba(0, 0, 0, 0.2);
    }

    .btn-secondary:hover {
      background-color: #f8f9fa;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    .card {
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      background-color: #fff;
      margin-bottom: 20px;
    }

    .card-header {
      background-color: #f8f9fa;
      border-bottom: 2px solid rgba(0, 0, 0, 0.2);
      padding: 15px 20px;
      font-weight: 600;
      color: #000;
    }

    .table {
      color: #000;
    }

    .table thead {
      background-color: #f8f9fa;
    }

    .table thead th {
      border-bottom: 2px solid rgba(0, 0, 0, 0.2);
      font-weight: 600;
      color: #000;
      padding: 12px;
    }

    .table tbody td {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      padding: 12px;
      color: #000;
    }

    .table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: 600;
      font-size: 0.85rem;
      border: 1px solid rgba(0, 0, 0, 0.2);
      background: #fff;
      color: #000;
    }

    .badge-present {
      border-color: rgba(0, 0, 0, 0.3);
    }

    .badge-absent {
      border-color: rgba(0, 0, 0, 0.3);
    }

    .badge-late {
      border-color: rgba(0, 0, 0, 0.3);
    }

    .badge-departed {
      border-color: rgba(0, 0, 0, 0.3);
    }

    .page-header {
      border-bottom: 2px solid rgba(0, 0, 0, 0.2);
      background: linear-gradient(to bottom, #ffffff, #f8f9fa);
      padding: 20px 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .page-header h2 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #000;
      margin: 0;
    }

    .nav-tabs {
      border-bottom: 2px solid rgba(0, 0, 0, 0.2);
    }

    .nav-tabs .nav-link {
      color: #000;
      border: 2px solid transparent;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      padding: 10px 20px;
      font-weight: 600;
    }

    .nav-tabs .nav-link:hover {
      border-color: rgba(0, 0, 0, 0.1);
      background-color: #f8f9fa;
    }

    .nav-tabs .nav-link.active {
      color: #000;
      background-color: #fff;
      border-color: rgba(0, 0, 0, 0.2);
      border-bottom-color: #fff;
    }

    .tab-content {
      padding: 20px 0;
    }

    .info-row {
      padding: 10px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #000;
      margin-bottom: 5px;
    }

    .info-value {
      color: #000;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
    }

    .btn-action {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .btn-view {
      background-color: #0d6efd;
      color: white;
    }

    .btn-view:hover {
      background-color: #0b5ed7;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background-color: #bb2d3b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .btn-action i {
      font-size: 18px;
      margin-left: 4px;
    }
  </style>
</head>

<body class="g-sidenav-show rtl bg-gray-100">
  <%- include('partials/aside') %>
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <%- include('partials/nav') %>

    <div class="container-fluid py-2">
      <!-- Header -->
      <div class="page-header">
        <h2 class="mb-0">
          <i class="material-symbols-rounded me-2" style="font-size: 28px; vertical-align: middle;">history</i>
          سجل الطالب الشامل
        </h2>
        <p class="text-sm">عرض جميع سجلات الطالب (حضور، مدفوعات، وغيرها)</p>
      </div>

      <!-- Search Section -->
      <div class="search-section">
        <div class="row align-items-end">
          <div class="col-md-8">
            <label class="form-label" style="font-weight: 600; color: #000;">ابحث بكود الطالب</label>
            <div class="input-group">
              <input type="text" class="form-control" id="studentCodeSearch" placeholder="أدخل كود الطالب (5 أرقام)" maxlength="5">
              <button class="btn btn-primary" type="button" onclick="searchStudent()">
                <i class="material-symbols-rounded me-2">search</i>بحث
              </button>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <button class="btn btn-secondary" onclick="exportToExcel()" id="exportBtn" style="display: none;">
              <i class="material-symbols-rounded me-2">download</i>تصدير Excel
            </button>
          </div>
        </div>
      </div>

      <!-- Student Info Card (Hidden Initially) -->
      <div id="studentInfoSection" style="display: none;">
        <div class="student-info-card">
          <div class="row">
            <div class="col-md-8">
              <h4 class="mb-3" id="studentName">اسم الطالب</h4>
              <div class="row">
                <div class="col-md-4 info-row">
                  <div class="info-label">كود الطالب:</div>
                  <div class="info-value" id="studentCode">---</div>
                </div>
                <div class="col-md-4 info-row">
                  <div class="info-label">الفصل:</div>
                  <div class="info-value" id="studentClass">---</div>
                </div>
                <div class="col-md-4 info-row">
                  <div class="info-label">ولي الأمر:</div>
                  <div class="info-value" id="parentName">---</div>
                </div>
                <div class="col-md-4 info-row">
                  <div class="info-label">رقم الهاتف:</div>
                  <div class="info-value" id="parentPhone">---</div>
                </div>
                <div class="col-md-4 info-row">
                  <div class="info-label">الرسوم الدراسية:</div>
                  <div class="info-value" id="totalFees">---</div>
                </div>
                <div class="col-md-4 info-row">
                  <div class="info-label">المتبقي:</div>
                  <div class="info-value" id="remainingBalance">---</div>
                </div>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <div class="stats-card">
                <div class="stats-icon">
                  <i class="material-symbols-rounded">percent</i>
                </div>
                <div class="stats-number" id="attendanceRate">0%</div>
                <div class="stats-label">نسبة الحضور</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
              <div class="stats-icon">
                <i class="material-symbols-rounded">check_circle</i>
              </div>
              <div class="stats-number" id="totalPresent">0</div>
              <div class="stats-label">أيام الحضور</div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
              <div class="stats-icon">
                <i class="material-symbols-rounded">cancel</i>
              </div>
              <div class="stats-number" id="totalAbsent">0</div>
              <div class="stats-label">أيام الغياب</div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
              <div class="stats-icon">
                <i class="material-symbols-rounded">schedule</i>
              </div>
              <div class="stats-number" id="totalLate">0</div>
              <div class="stats-label">متأخر</div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
              <div class="stats-icon">
                <i class="material-symbols-rounded">payments</i>
              </div>
              <div class="stats-number" id="totalPaid">0</div>
              <div class="stats-label">إجمالي المدفوع</div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="logTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
              <i class="material-symbols-rounded me-2">fact_check</i>سجل الحضور
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
              <i class="material-symbols-rounded me-2">payments</i>سجل المدفوعات
            </button>
          </li>
        </ul>

        <div class="tab-content" id="logTabContent">
          <!-- Attendance Tab -->
          <div class="tab-pane fade show active" id="attendance" role="tabpanel">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">سجل الحضور الكامل</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                  <table class="table align-items-center mb-0">
                    <thead style="position: sticky; top: 0; z-index: 10; background: #f8f9fa;">
                      <tr>
                        <th>#</th>
                        <th>التاريخ</th>
                        <th>اليوم</th>
                        <th>الفصل</th>
                        <th>وقت الدخول</th>
                        <th>وقت الخروج</th>
                        <th>الحالة</th>
                        <th>طريقة التحقق</th>
                        <th>ملاحظات</th>
                        <th class="text-center">الإجراءات</th>
                      </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                      <tr>
                        <td colspan="10" class="text-center py-5 text-muted">جاري التحميل...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Payments Tab -->
          <div class="tab-pane fade" id="payments" role="tabpanel">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">سجل المدفوعات</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                  <table class="table align-items-center mb-0">
                    <thead style="position: sticky; top: 0; z-index: 10; background: #f8f9fa;">
                      <tr>
                        <th>#</th>
                        <th>التاريخ</th>
                        <th>المبلغ</th>
                        <th>طريقة الدفع</th>
                        <th>المستلم</th>
                        <th>ملاحظات</th>
                      </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                      <tr>
                        <td colspan="6" class="text-center py-5 text-muted">جاري التحميل...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script>
    let currentStudentId = null;

    async function searchStudent() {
      const code = document.getElementById('studentCodeSearch').value.trim();
      if (!code || code.length !== 5) {
        alert('يرجى إدخال كود طالب صحيح (5 أرقام)');
        return;
      }

      try {
        const response = await axios.get(`/admin/student-log-by-code/${code}`);
        if (response.data.success) {
          currentStudentId = response.data.student._id;
          displayStudentData(response.data);
          document.getElementById('studentInfoSection').style.display = 'block';
          document.getElementById('exportBtn').style.display = 'block';
        } else {
          alert('لم يتم العثور على طالب بهذا الكود');
        }
      } catch (error) {
        console.error('Error searching student:', error);
        if (error.response && error.response.status === 404) {
          alert('لم يتم العثور على طالب بهذا الكود');
        } else {
          alert('حدث خطأ في البحث');
        }
      }
    }

    function displayStudentData(data) {
      const student = data.student;
      const attendance = data.attendance || [];
      const payments = data.payments || [];

      // Display student info
      document.getElementById('studentName').textContent = student.studentName || 'غير معروف';
      document.getElementById('studentCode').textContent = student.studentCode || 'N/A';
      document.getElementById('studentClass').textContent = student.class?.className || 'غير محدد';
      document.getElementById('parentName').textContent = student.parentName || 'غير معروف';
      document.getElementById('parentPhone').textContent = student.parentPhone1 || 'غير متوفر';
      document.getElementById('totalFees').textContent = (student.totalSchoolFees || 0) + ' ج.م';
      document.getElementById('remainingBalance').textContent = (student.remainingBalance || 0) + ' ج.م';

      // Calculate statistics
      const present = attendance.filter(a => a.status === 'Present').length;
      const absent = attendance.filter(a => a.status === 'Absent').length;
      const late = attendance.filter(a => a.status === 'Late').length;
      const total = attendance.length;
      const attendanceRate = total > 0 ? (((present + late) / total) * 100).toFixed(1) : 0;
      const totalPaid = payments.reduce((sum, p) => sum + (p.amount || 0), 0);

      // Update statistics
      document.getElementById('totalPresent').textContent = present;
      document.getElementById('totalAbsent').textContent = absent;
      document.getElementById('totalLate').textContent = late;
      document.getElementById('attendanceRate').textContent = attendanceRate + '%';
      document.getElementById('totalPaid').textContent = totalPaid + ' ج.م';

      // Render attendance table
      renderAttendanceTable(attendance);
      
      // Render payments table
      renderPaymentsTable(payments);
    }

    function renderAttendanceTable(attendance) {
      const tbody = document.getElementById('attendanceTableBody');
      
      if (!attendance || attendance.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center py-5 text-muted">لا توجد سجلات حضور</td></tr>';
        return;
      }

      // Sort by date descending (latest first)
      attendance.sort((a, b) => new Date(b.date) - new Date(a.date));

      tbody.innerHTML = attendance.map((att, index) => {
        const date = new Date(att.date);
        const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' });
        
        let statusBadge = '';
        if (att.status === 'Present') {
          statusBadge = '<span class="status-badge badge-present"><i class="material-symbols-rounded me-1" style="font-size: 16px;">check_circle</i>حاضر</span>';
        } else if (att.status === 'Absent') {
          statusBadge = '<span class="status-badge badge-absent"><i class="material-symbols-rounded me-1" style="font-size: 16px;">cancel</i>غائب</span>';
        } else if (att.status === 'Late') {
          statusBadge = '<span class="status-badge badge-late"><i class="material-symbols-rounded me-1" style="font-size: 16px;">schedule</i>متأخر</span>';
        } else if (att.status === 'Early-Leave') {
          statusBadge = '<span class="status-badge badge-departed"><i class="material-symbols-rounded me-1" style="font-size: 16px;">logout</i>انصراف مبكر</span>';
        }

        // Get verify method display
        const verifyMethod = att.verifyMethod || 'Face Recognition';
        let verifyIcon = 'face';
        let verifyText = 'تعرف الوجه';
        if (verifyMethod.includes('Fingerprint') || verifyMethod.includes('fingerprint')) {
          verifyIcon = 'fingerprint';
          verifyText = 'بصمة';
        } else if (verifyMethod.includes('Card') || verifyMethod.includes('RFID')) {
          verifyIcon = 'credit_card';
          verifyText = 'بطاقة';
        } else if (verifyMethod.includes('Password')) {
          verifyIcon = 'lock';
          verifyText = 'كلمة مرور';
        }

        return `
          <tr id="attendance-row-${att._id}">
            <td>${index + 1}</td>
            <td>${date.toLocaleDateString('ar-EG')}</td>
            <td>${dayName}</td>
            <td>${att.class?.className || 'غير محدد'}</td>
            <td>
              ${att.entryTime ? `
                <i class="material-symbols-rounded me-1" style="font-size: 16px; vertical-align: middle;">schedule</i>
                ${new Date(att.entryTime).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true })}
              ` : '---'}
            </td>
            <td>${att.exitTime ? new Date(att.exitTime).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true }) : '---'}</td>
            <td>${statusBadge}</td>
            <td>
              <i class="material-symbols-rounded me-1" style="font-size: 16px; vertical-align: middle;">${verifyIcon}</i>
              ${verifyText}
            </td>
            <td>${att.notes || att.leaveReason || '---'}</td>
            <td class="text-center">
              <div class="action-buttons">
                <button class="btn-action btn-view" onclick="viewAttendanceDetails('${att._id}')" title="عرض التفاصيل">
                  <i class="material-symbols-rounded">visibility</i>
                  <span>عرض</span>
                </button>
                <button class="btn-action btn-delete" onclick="deleteAttendance('${att._id}', '${att.student?.studentName || 'هذا السجل'}')" title="حذف السجل">
                  <i class="material-symbols-rounded">delete</i>
                  <span>حذف</span>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderPaymentsTable(payments) {
      const tbody = document.getElementById('paymentsTableBody');
      
      if (!payments || payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">لا توجد مدفوعات مسجلة</td></tr>';
        return;
      }

      // Sort by date descending (latest first)
      payments.sort((a, b) => new Date(b.paymentDate || b.createdAt) - new Date(a.paymentDate || a.createdAt));

      tbody.innerHTML = payments.map((payment, index) => {
        const paymentDate = new Date(payment.paymentDate || payment.createdAt);
        const paymentMethod = payment.paymentMethod === 'cash' ? 'نقدي' : 
                             payment.paymentMethod === 'bank_transfer' ? 'تحويل بنكي' :
                             payment.paymentMethod === 'card' ? 'بطاقة' : 'أخرى';

        return `
          <tr>
            <td>${index + 1}</td>
            <td>${paymentDate.toLocaleDateString('ar-EG')}</td>
            <td><strong>${payment.amount} ج.م</strong></td>
            <td>${paymentMethod}</td>
            <td>${payment.receivedBy?.employeeName || 'غير معروف'}</td>
            <td>${payment.notes || '---'}</td>
          </tr>
        `;
      }).join('');
    }

    function exportToExcel() {
      if (!currentStudentId) {
        alert('يرجى البحث عن طالب أولاً');
        return;
      }
      window.location.href = `/admin/export-student-log/${currentStudentId}`;
    }

    // View attendance details
    function viewAttendanceDetails(attendanceId) {
      // Find the attendance record
      const row = document.getElementById(`attendance-row-${attendanceId}`);
      if (!row) return;

      // Get all data from the row
      const cells = row.querySelectorAll('td');
      const details = {
        date: cells[1].textContent,
        day: cells[2].textContent,
        class: cells[3].textContent,
        entryTime: cells[4].textContent,
        exitTime: cells[5].textContent,
        status: cells[6].textContent,
        verifyMethod: cells[7].textContent,
        notes: cells[8].textContent
      };

      // Show details in a modal or alert
      const detailsText = `
تفاصيل سجل الحضور:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
التاريخ: ${details.date}
اليوم: ${details.day}
الفصل: ${details.class}
وقت الدخول: ${details.entryTime}
وقت الخروج: ${details.exitTime}
الحالة: ${details.status}
طريقة التحقق: ${details.verifyMethod}
الملاحظات: ${details.notes}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      `;
      
      alert(detailsText);
    }

    // Delete attendance record
    async function deleteAttendance(attendanceId, studentName) {
      if (!confirm(`هل أنت متأكد من حذف سجل الحضور للطالب "${studentName}"؟\n\n⚠️ تحذير: لا يمكن التراجع عن هذا الإجراء!`)) {
        return;
      }

      try {
        const response = await axios.delete(`/admin/attendance/student/${attendanceId}`);
        
        if (response.data.success) {
          // Remove the row from table
          const row = document.getElementById(`attendance-row-${attendanceId}`);
          if (row) {
            row.style.transition = 'opacity 0.3s ease';
            row.style.opacity = '0';
            setTimeout(() => {
              row.remove();
              
              // Check if table is empty
              const tbody = document.getElementById('attendanceTableBody');
              if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-5 text-muted">لا توجد سجلات حضور</td></tr>';
              } else {
                // Renumber rows
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                  const firstCell = row.querySelector('td');
                  if (firstCell) {
                    firstCell.textContent = index + 1;
                  }
                });
              }
            }, 300);
          }
          
          // Show success message
          alert('✅ تم حذف سجل الحضور بنجاح');
          
          // Refresh statistics
          if (currentStudentId) {
            searchStudent();
          }
        } else {
          alert('❌ حدث خطأ أثناء حذف السجل');
        }
      } catch (error) {
        console.error('Error deleting attendance:', error);
        if (error.response && error.response.status === 404) {
          alert('❌ لم يتم العثور على السجل');
        } else if (error.response && error.response.status === 401) {
          alert('❌ غير مصرح لك بحذف هذا السجل');
        } else {
          alert('❌ حدث خطأ أثناء حذف السجل: ' + (error.response?.data?.error || error.message));
        }
      }
    }

    // Allow Enter key to search
    document.getElementById('studentCodeSearch').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchStudent();
      }
    });
  </script>
</body>

</html>
