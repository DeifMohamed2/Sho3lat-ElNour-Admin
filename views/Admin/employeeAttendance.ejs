<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <%- include('partials/head') %>
  <title>حضور وانصراف الموظفين - <%= new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></title>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .stats-card {
      background: white;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stats-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .stats-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
      color: #000;
    }

    .stats-label {
      color: #000;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .stats-icon {
      font-size: 1.5rem;
      color: #000;
      margin-bottom: 10px;
    }

    .filter-section {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    .filter-label {
      font-weight: 600;
      color: #000;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .form-control,
    .form-select {
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 10px 15px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background-color: #fff;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: rgba(0, 0, 0, 0.5);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: 600;
      font-size: 0.85rem;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .status-present {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    .status-late {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    .status-absent {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    .status-on-leave {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    /* Professional Row Color Coding */
    .row-departed {
      background-color: #d4edda !important;
      border-right: 4px solid #28a745 !important;
    }

    .row-departed td {
      background-color: #d4edda !important;
    }

    .row-late {
      background-color: #fff3cd !important;
      border-right: 4px solid #ffc107 !important;
    }

    .row-late td {
      background-color: #fff3cd !important;
    }

    .row-absent {
      background-color: #f8d7da !important;
      border-right: 4px solid #dc3545 !important;
    }

    .row-absent td {
      background-color: #f8d7da !important;
    }

    .row-present {
      background-color: #fff !important;
      border-right: 4px solid #0d6efd !important;
    }

    .row-present td {
      background-color: #fff !important;
    }

    /* Departure Status Badge */
    .departure-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .departure-badge.departed {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .departure-badge.pending {
      background: #f8f9fa;
      color: #6c757d;
      border: 1px dashed rgba(0, 0, 0, 0.3);
    }

    /* Duration Badge */
    .duration-badge {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    #presentTable,
    #absentTable,
    #departedTable {
      border-collapse: collapse;
      border: 2px solid rgba(0, 0, 0, 0.3);
      width: 100%;
    }

    #presentTable th,
    #presentTable td,
    #absentTable th,
    #absentTable td,
    #departedTable th,
    #departedTable td {
      text-align: center;
      color: black !important;
      border: 1px solid rgba(0, 0, 0, 0.2);
      padding: 12px 8px;
    }

    #presentTable thead,
    #absentTable thead,
    #departedTable thead {
      background-color: #fff;
    }

    #presentTable thead th,
    #absentTable thead th,
    #departedTable thead th {
      border-bottom: 2px solid rgba(0, 0, 0, 0.3);
      font-weight: bold;
      background-color: #f8f9fa;
      border-top: 2px solid rgba(0, 0, 0, 0.3);
    }

    #presentTable tbody tr,
    #absentTable tbody tr,
    #departedTable tbody tr {
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    #presentTable tbody tr:last-child,
    #absentTable tbody tr:last-child,
    #departedTable tbody tr:last-child {
      border-bottom: none;
    }

    #presentTable tbody td,
    #absentTable tbody td,
    #departedTable tbody td {
      background-color: #fff;
    }

    .table-responsive {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .table-responsive table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #f8f9fa;
    }

    .btn {
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, #000 0%, #444 100%);
      border: none;
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(120deg, #111 0%, #555 100%);
      color: white;
    }

    .btn-secondary {
      background-color: #fff;
      color: #000;
      border: 2px solid rgba(0, 0, 0, 0.2);
    }

    .btn-secondary:hover {
      background-color: #f8f9fa;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    .btn-outline-dark {
      background-color: #fff;
      color: #000;
      border: 2px solid rgba(0, 0, 0, 0.2);
    }

    .btn-outline-dark:hover {
      background-color: #000;
      color: #fff;
      border-color: #000;
    }

    .nav-tabs {
      border-bottom: 2px solid rgba(0, 0, 0, 0.2);
    }

    .nav-tabs .nav-link {
      color: #000;
      border: 2px solid transparent;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      padding: 10px 20px;
      font-weight: 600;
    }

    .nav-tabs .nav-link:hover {
      border-color: rgba(0, 0, 0, 0.1);
      background-color: #f8f9fa;
    }

    .nav-tabs .nav-link.active {
      color: #000;
      background-color: #fff;
      border-color: rgba(0, 0, 0, 0.2);
      border-bottom-color: #fff;
    }

    .card {
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      background-color: #fff;
    }

    .card-body {
      padding: 20px;
    }

    .badge {
      background-color: #f8f9fa;
      color: #000;
      border: 1px solid rgba(0, 0, 0, 0.2);
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: 600;
    }

    .scan-badge {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 5px;
      font-size: 0.75rem;
      background: #f8f9fa;
      color: #000;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .scan-in {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.2);
    }

    .scan-out {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.2);
    }

    .page-header {
      border-bottom: 2px solid rgba(0, 0, 0, 0.2);
      background: linear-gradient(to bottom, #ffffff, #f8f9fa);
      padding: 20px 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .page-header h2 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #000;
      margin: 0;
    }

    .page-header p {
      color: #000;
      margin: 5px 0 0 0;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
    }

    .btn-action {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .btn-view {
      background-color: #0d6efd;
      color: white;
    }

    .btn-view:hover {
      background-color: #0b5ed7;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background-color: #bb2d3b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .btn-action i {
      font-size: 18px;
      margin-left: 4px;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 0.8rem;
    }
  </style>
</head>

<body class="g-sidenav-show rtl bg-gray-100">
  <%- include('partials/aside') %>
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <%- include('partials/nav') %>

    <div class="container-fluid py-2">
      <!-- Header -->
      <div class="page-header">
        <h2 class="mb-0">
          <i class="material-symbols-rounded me-2" style="font-size: 28px; vertical-align: middle;">badge</i>
          حضور وانصراف الموظفين
        </h2>
        <p class="text-sm">
          <%= new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
        </p>
      </div>

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-lg-2 col-md-4 col-6 mb-3">
          <div class="stats-card">
            <div class="stats-icon">
              <i class="material-symbols-rounded">check_circle</i>
            </div>
            <div class="stats-number" id="presentCount">0</div>
            <div class="stats-label">حاضر</div>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
          <div class="stats-card">
            <div class="stats-icon">
              <i class="material-symbols-rounded">schedule</i>
            </div>
            <div class="stats-number" id="lateCount">0</div>
            <div class="stats-label">متأخر</div>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
          <div class="stats-card">
            <div class="stats-icon">
              <i class="material-symbols-rounded">cancel</i>
            </div>
            <div class="stats-number" id="absentCount">0</div>
            <div class="stats-label">غائب</div>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
          <div class="stats-card">
            <div class="stats-icon">
              <i class="material-symbols-rounded">logout</i>
            </div>
            <div class="stats-number" id="departedCount">0</div>
            <div class="stats-label">منصرف</div>
          </div>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
          <div class="stats-card">
            <div class="stats-icon">
              <i class="material-symbols-rounded">access_time</i>
            </div>
            <div class="stats-number" id="totalHours">0</div>
            <div class="stats-label">إجمالي الساعات</div>
          </div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="card filter-section">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-lg-3 col-md-6">
              <label class="filter-label">
                <i class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">calendar_today</i>
                التاريخ
              </label>
              <input type="date" class="form-control" id="filterDate" value="<%= new Date().toISOString().split('T')[0] %>">
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="filter-label">
                <i class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">person</i>
                نوع الموظف
              </label>
              <select class="form-select" id="filterType">
                <option value="">الجميع</option>
                <option value="teacher">معلم</option>
                <option value="other">آخرون</option>
              </select>
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="filter-label">
                <i class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">filter_list</i>
                الحالة
              </label>
              <select class="form-select" id="filterStatus">
                <option value="">جميع الحالات</option>
                <option value="Present">حاضر</option>
                <option value="Late">متأخر</option>
                <option value="Absent">غائب</option>
                <option value="departed">منصرف</option>
              </select>
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="filter-label">
                <i class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">search</i>
                بحث
              </label>
              <input type="text" class="form-control" id="searchEmployee" placeholder="اسم الموظف أو الكود...">
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <button class="btn btn-primary me-2" onclick="applyFilters()">
                <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">filter_alt</i>
                تطبيق الفلاتر
              </button>
              <button class="btn btn-outline-dark me-2" onclick="resetFilters()">
                <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">refresh</i>
                إعادة تعيين
              </button>
              <button class="btn btn-primary float-start" onclick="exportToExcel()">
                <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">download</i>
                تصدير Excel
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="attendanceTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="present-tab" data-bs-toggle="tab" data-bs-target="#present" type="button">
            <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">check_circle</i>
            الحضور
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="absent-tab" data-bs-toggle="tab" data-bs-target="#absent" type="button">
            <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">cancel</i>
            الغياب
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="attendanceTabContent">
        <!-- Present Employees -->
        <div class="tab-pane fade show active" id="present" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-items-center mb-0" id="presentTable">
                  <thead>
                    <tr>
                      <th class="text-center">#</th>
                      <th>الموظف</th>
                      <th>الكود</th>
                      <th>النوع</th>
                      <th>حضور</th>
                      <th>انصراف</th>
                      <th>عدد المسحات</th>
                      <th>الساعات</th>
                      <th>الحالة</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody id="presentTableBody">
                    <tr>
                      <td colspan="10" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Absent Employees -->
        <div class="tab-pane fade" id="absent" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-items-center mb-0" id="absentTable">
                  <thead>
                    <tr>
                      <th class="text-center">#</th>
                      <th>الموظف</th>
                      <th>الكود</th>
                      <th>النوع</th>
                      <th>رقم الهاتف</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody id="absentTableBody">
                    <tr>
                      <td colspan="6" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Core JS - Load Bootstrap first -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    let allData = [];
    let filteredData = [];
    let currentTab = 'present';
    
    // Format time in Egypt timezone - same method as student attendance
    function formatTime(dateValue) {
      if (!dateValue) return null;
      const date = typeof dateValue === 'string' ? new Date(dateValue) : dateValue;
      if (!date || isNaN(date.getTime())) return null;
      return date.toLocaleTimeString('ar-EG', { 
        hour: '2-digit', 
        minute: '2-digit', 
        timeZone: 'Africa/Cairo' 
      });
    }
    
    // Check if employee actually checked out (checkOutTime exists and is different from checkInTime)
    function hasActuallyCheckedOut(checkInTime, checkOutTime) {
      if (!checkInTime || !checkOutTime) return false;
      const checkIn = typeof checkInTime === 'string' ? new Date(checkInTime) : checkInTime;
      const checkOut = typeof checkOutTime === 'string' ? new Date(checkOutTime) : checkOutTime;
      if (!checkIn || !checkOut || isNaN(checkIn.getTime()) || isNaN(checkOut.getTime())) return false;
      // Check if check-out time is different from check-in time (at least 1 minute difference)
      return Math.abs(checkOut.getTime() - checkIn.getTime()) > 60000; // 1 minute in milliseconds
    }
    
    // Calculate hours between two times
    function calculateHours(checkInTime, checkOutTime) {
      if (!checkInTime || !checkOutTime) return 0;
      
      const checkIn = typeof checkInTime === 'string' ? new Date(checkInTime) : checkInTime;
      const checkOut = typeof checkOutTime === 'string' ? new Date(checkOutTime) : checkOutTime;
      
      if (!checkIn || !checkOut || isNaN(checkIn.getTime()) || isNaN(checkOut.getTime())) return 0;
      
      // Only calculate if check-out is actually different from check-in
      if (!hasActuallyCheckedOut(checkInTime, checkOutTime)) return 0;
      
      const diffMs = checkOut.getTime() - checkIn.getTime();
      const diffHours = diffMs / (1000 * 60 * 60);
      return Math.max(0, Math.round(diffHours * 100) / 100); // Round to 2 decimals, ensure non-negative
    }

    // Load attendance data with filters
    async function loadAttendanceData() {
      const date = document.getElementById('filterDate').value;
      const employeeType = document.getElementById('filterType').value;
      const status = document.getElementById('filterStatus').value;
      const search = document.getElementById('searchEmployee').value;
      
      // First, load ALL attendance data for statistics (no tab filter)
      const statsParams = new URLSearchParams({ date: date });
      if (employeeType) statsParams.append('employeeType', employeeType);
      if (status) statsParams.append('status', status);
      if (search) statsParams.append('search', search);
      
      // Then, load tab-specific data for table display
      const tableParams = new URLSearchParams({
        date: date,
        tab: currentTab
      });
      if (employeeType) tableParams.append('employeeType', employeeType);
      if (status) tableParams.append('status', status);
      if (search) tableParams.append('search', search);

      try {
        // Load all data for accurate statistics
        const [statsResponse, tableResponse] = await Promise.all([
          axios.get(`/admin/employee-attendance-dashboard-data?${statsParams.toString()}`),
          axios.get(`/admin/employee-attendance-dashboard-data?${tableParams.toString()}`)
        ]);
        
        // Use all data for statistics
        allData = statsResponse.data.attendance || [];
        // Use filtered data for table display
        filteredData = tableResponse.data.attendance || [];
        
        updateStatistics();
        renderTables();
      } catch (error) {
        console.error('Error loading attendance:', error);
        showNotification('حدث خطأ في تحميل البيانات', 'danger');
      }
    }

    // Update statistics (uses allData for accurate counts)
    function updateStatistics() {
      const present = allData.filter(a => (a.status === 'Present' || a.status === 'Late') && a.checkInTime).length;
      const late = allData.filter(a => a.status === 'Late').length;
      const absent = allData.filter(a => a.status === 'Absent').length;
      // Only count as departed if they actually checked out (checkOutTime is different from checkInTime)
      const departed = allData.filter(a => a.checkOutTime && hasActuallyCheckedOut(a.checkInTime, a.checkOutTime)).length;
      const totalHours = allData.reduce((sum, a) => {
        // Only count hours if they actually checked out
        if (a.checkOutTime && hasActuallyCheckedOut(a.checkInTime, a.checkOutTime)) {
          return sum + (calculateHours(a.checkInTime, a.checkOutTime) || 0);
        }
        return sum;
      }, 0);

      document.getElementById('presentCount').textContent = present;
      document.getElementById('lateCount').textContent = late;
      document.getElementById('absentCount').textContent = absent;
      document.getElementById('departedCount').textContent = departed;
      document.getElementById('totalHours').textContent = totalHours.toFixed(1) + 'س';
    }

    // Render tables
    function renderTables() {
      renderPresentTable();
      renderAbsentTable();
    }

    // Render present employees with color coding
    function renderPresentTable() {
      const tbody = document.getElementById('presentTableBody');
      // Include records with Present or Late status
      const present = filteredData.filter(a => (a.status === 'Present' || a.status === 'Late'));

      if (present.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center py-5 text-muted">لا توجد بيانات</td></tr>';
        return;
      }

      tbody.innerHTML = present.map((att, index) => {
        // Determine row class based on status
        let rowClass = 'row-present';
        if (att.checkOutTime && hasActuallyCheckedOut(att.checkInTime, att.checkOutTime)) {
          rowClass = 'row-departed';
        } else if (att.status === 'Late') {
          rowClass = 'row-late';
        }
        
        // Calculate duration for departed employees
        const hours = calculateHours(att.checkInTime, att.checkOutTime);
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        const durationText = hasActuallyCheckedOut(att.checkInTime, att.checkOutTime) ? `${h}س ${m}د` : '-';
        
        return `
                <tr id="attendance-row-${att._id}" class="${rowClass}">
                    <td class="text-center">${index + 1}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-2" style="width: 32px; height: 32px; border-radius: 50%; background-color: #f8f9fa; border: 2px solid rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                                <span style="color: #000; font-weight: 600;">${att.employee?.employeeName?.charAt(0) || 'م'}</span>
                            </div>
                            <span class="fw-bold">${att.employee?.employeeName || 'غير معروف'}</span>
                        </div>
                    </td>
                    <td><span class="badge">${att.employee?.employeeCode || 'N/A'}</span></td>
                    <td><span class="badge">${getEmployeeType(att.employee?.employeeType)}</span></td>
                    <td>
                        <i class="material-symbols-rounded me-1" style="font-size: 16px; vertical-align: middle;">login</i>
                        ${att.checkInTime ? formatTime(att.checkInTime) : '---'}
                    </td>
                    <td>
                        ${att.checkOutTime && hasActuallyCheckedOut(att.checkInTime, att.checkOutTime) ? 
                            `<span class="departure-badge departed">
                                <i class="material-symbols-rounded" style="font-size: 14px;">check_circle</i>
                                ${formatTime(att.checkOutTime)}
                            </span>` : 
                            `<span class="departure-badge pending">
                                <i class="material-symbols-rounded" style="font-size: 14px;">schedule</i>
                                في الانتظار
                            </span>`}
                    </td>
                    <td><span class="badge">${att.scans?.length || 0}</span></td>
                    <td><span class="duration-badge">${durationText}</span></td>
                    <td><span class="status-badge status-${att.status.toLowerCase()}">${getStatusText(att.status)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view btn-sm" onclick="viewEmployeeDetails('${att.employee?._id}')" title="عرض التفاصيل">
                                <i class="material-symbols-rounded">visibility</i>
                            </button>
                            <button class="btn-action btn-delete btn-sm" onclick="deleteEmployeeAttendance('${att._id}', '${att.employee?.employeeName || 'هذا السجل'}')" title="حذف السجل">
                                <i class="material-symbols-rounded">delete</i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
      }).join('');
    }

    // Render absent employees
    function renderAbsentTable() {
      const tbody = document.getElementById('absentTableBody');
      const absent = filteredData.filter(a => a.status === 'Absent');

      if (absent.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">لا توجد بيانات</td></tr>';
        return;
      }

      tbody.innerHTML = absent.map((att, index) => `
                <tr id="attendance-row-${att._id}">
                    <td class="text-center">${index + 1}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-2" style="width: 32px; height: 32px; border-radius: 50%; background-color: #f8f9fa; border: 2px solid rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                                <span style="color: #000; font-weight: 600;">${att.employee?.employeeName?.charAt(0) || 'م'}</span>
                            </div>
                            <span class="fw-bold">${att.employee?.employeeName || 'غير معروف'}</span>
                        </div>
                    </td>
                    <td><span class="badge">${att.employee?.employeeCode || 'N/A'}</span></td>
                    <td><span class="badge">${getEmployeeType(att.employee?.employeeType)}</span></td>
                    <td>${att.employee?.employeePhoneNumber || 'غير متوفر'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view btn-sm" onclick="viewEmployeeDetails('${att.employee?._id}')" title="عرض التفاصيل">
                                <i class="material-symbols-rounded">visibility</i>
                            </button>
                            <button class="btn-action btn-delete btn-sm" onclick="deleteEmployeeAttendance('${att._id}', '${att.employee?.employeeName || 'هذا السجل'}')" title="حذف السجل">
                                <i class="material-symbols-rounded">delete</i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
    }
    // Render scans
    function renderScans(scans) {
      if (!scans || scans.length === 0) return '';

      const scanHtml = scans.slice(0, 3).map(scan => {
        const time = formatTime(scan.scanTime);
        return `<span class="scan-badge">${time}</span>`;
      }).join('');

      return `<div class="mt-1">${scanHtml}${scans.length > 3 ? '...' : ''}</div>`;
    }

    // Apply filters - reload data from API
    function applyFilters() {
      loadAttendanceData();
    }

    // Reset filters
    function resetFilters() {
      document.getElementById('filterType').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('searchEmployee').value = '';
      document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
      currentTab = 'present';
      // Reset tab to present
      const presentTab = document.getElementById('present-tab');
      if (presentTab) {
        const tab = new bootstrap.Tab(presentTab);
        tab.show();
      }
      loadAttendanceData();
    }

    // Handle tab change
    function handleTabChange(tabName) {
      currentTab = tabName;
      loadAttendanceData();
    }

    // Helper functions
    function getStatusText(status) {
      const statusMap = {
        'Present': 'حاضر',
        'Late': 'متأخر',
        'Absent': 'غائب',
        'Half-Day': 'نصف يوم',
        'On-Leave': 'إجازة'
      };
      return statusMap[status] || status;
    }

    function getEmployeeType(type) {
      return type === 'teacher' ? 'معلم' : 'إداري';
    }

    function viewEmployeeDetails(employeeId) {
      window.location.href = `/admin/employee-log-view/${employeeId}`;
    }

    function viewScans(attendanceId) {
      // Show modal with all scans
      alert('عرض كل المسحات - قريباً');
    }

    function contactEmployee(employeeId) {
      showNotification('سيتم التواصل مع الموظف قريباً', 'info');
    }

    // Delete employee attendance record
    async function deleteEmployeeAttendance(attendanceId, employeeName) {
      if (!confirm(`هل أنت متأكد من حذف سجل الحضور للموظف "${employeeName}"؟\n\n⚠️ تحذير: لا يمكن التراجع عن هذا الإجراء!`)) {
        return;
      }

      try {
        const response = await axios.delete(`/admin/attendance/employee/${attendanceId}`);
        
        if (response.data.success) {
          // Remove the row from table with animation
          const row = document.getElementById(`attendance-row-${attendanceId}`);
          if (row) {
            row.style.transition = 'opacity 0.3s ease';
            row.style.opacity = '0';
            setTimeout(() => {
              row.remove();
              
              // Check if table is empty and update statistics
              const tbody = row.closest('tbody');
              if (tbody && tbody.children.length === 0) {
                const tableId = tbody.id;
                if (tableId === 'presentTableBody') {
                  tbody.innerHTML = '<tr><td colspan="10" class="text-center py-5 text-muted">لا توجد بيانات</td></tr>';
                } else if (tableId === 'absentTableBody') {
                  tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">لا توجد بيانات</td></tr>';
                } else if (tableId === 'departedTableBody') {
                  tbody.innerHTML = '<tr><td colspan="9" class="text-center py-5 text-muted">لا توجد بيانات</td></tr>';
                }
              }
              
              // Reload data to refresh statistics and renumber rows
              loadAttendanceData();
            }, 300);
          } else {
            // If row not found, just reload
            loadAttendanceData();
          }
          
          showNotification('✅ تم حذف سجل الحضور بنجاح', 'success');
        } else {
          showNotification('❌ حدث خطأ أثناء حذف السجل', 'danger');
        }
      } catch (error) {
        console.error('Error deleting employee attendance:', error);
        if (error.response && error.response.status === 404) {
          showNotification('❌ لم يتم العثور على السجل', 'danger');
        } else if (error.response && error.response.status === 401) {
          showNotification('❌ غير مصرح لك بحذف هذا السجل', 'danger');
        } else {
          showNotification('❌ حدث خطأ أثناء حذف السجل: ' + (error.response?.data?.error || error.message), 'danger');
        }
      }
    }

    function exportToExcel() {
      const date = document.getElementById('filterDate').value;
      const employeeType = document.getElementById('filterType').value;
      const status = document.getElementById('filterStatus').value;
      const search = document.getElementById('searchEmployee').value;
      
      // Build query params
      const params = new URLSearchParams({
        date: date,
        tab: currentTab
      });
      
      if (employeeType) params.append('employeeType', employeeType);
      if (status) params.append('status', status);
      if (search) params.append('search', search);

      window.location.href = `/admin/export-employee-attendance?${params.toString()}`;
    }

    function showNotification(message, type = 'success') {
      alert(message);
    }

    // Event listeners
    document.getElementById('filterDate').addEventListener('change', loadAttendanceData);
    document.getElementById('searchEmployee').addEventListener('input', debounce(applyFilters, 500));
    document.getElementById('filterType').addEventListener('change', applyFilters);
    document.getElementById('filterStatus').addEventListener('change', applyFilters);

    // Tab event listeners
    const presentTab = document.getElementById('present-tab');
    const absentTab = document.getElementById('absent-tab');

    if (presentTab) {
      presentTab.addEventListener('shown.bs.tab', () => handleTabChange('present'));
    }
    if (absentTab) {
      absentTab.addEventListener('shown.bs.tab', () => handleTabChange('absent'));
    }

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadAttendanceData();
    });
  </script>
</body>

</html>