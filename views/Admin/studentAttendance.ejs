<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <%- include('partials/head') %>
  <title>حضور الطلاب - <%= new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></title>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .stats-card {
      background: white;
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .stats-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .stats-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
      color: #000;
    }

    .stats-label {
      color: #000;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .stats-icon {
      font-size: 1.5rem;
      color: #000;
      margin-bottom: 10px;
    }

    .filter-section {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    .filter-label {
      font-weight: 600;
      color: #000;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .form-control,
    .form-select {
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 10px 15px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background-color: #fff;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: rgba(0, 0, 0, 0.5);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: 600;
      font-size: 0.85rem;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .status-present {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    .status-late {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    .status-absent {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    .status-departed {
      background: #fff;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    #presentTable,
    #absentTable,
    #departedTable {
      border-collapse: collapse;
      border: 2px solid rgba(0, 0, 0, 0.3);
      width: 100%;
    }

    #presentTable th,
    #presentTable td,
    #absentTable th,
    #absentTable td,
    #departedTable th,
    #departedTable td {
      text-align: center;
      color: black !important;
      border: 1px solid rgba(0, 0, 0, 0.2);
      padding: 12px 8px;
    }

    #presentTable thead,
    #absentTable thead,
    #departedTable thead {
      background-color: #fff;
    }

    #presentTable thead th,
    #absentTable thead th,
    #departedTable thead th {
      border-bottom: 2px solid rgba(0, 0, 0, 0.3);
      font-weight: bold;
      background-color: #f8f9fa;
      border-top: 2px solid rgba(0, 0, 0, 0.3);
    }

    #presentTable tbody tr,
    #absentTable tbody tr,
    #departedTable tbody tr {
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    #presentTable tbody tr:last-child,
    #absentTable tbody tr:last-child,
    #departedTable tbody tr:last-child {
      border-bottom: none;
    }

    #presentTable tbody td,
    #absentTable tbody td,
    #departedTable tbody td {
      background-color: #fff;
    }

    .table-responsive {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .table-responsive table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #f8f9fa;
    }

    .btn {
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, #000 0%, #444 100%);
      border: none;
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(120deg, #111 0%, #555 100%);
      color: white;
    }

    .btn-secondary {
      background-color: #fff;
      color: #000;
      border: 2px solid rgba(0, 0, 0, 0.2);
    }

    .btn-secondary:hover {
      background-color: #f8f9fa;
      color: #000;
      border-color: rgba(0, 0, 0, 0.3);
    }

    .btn-outline-dark {
      background-color: #fff;
      color: #000;
      border: 2px solid rgba(0, 0, 0, 0.2);
    }

    .btn-outline-dark:hover {
      background-color: #000;
      color: #fff;
      border-color: #000;
    }

    .nav-tabs {
      border-bottom: 2px solid rgba(0, 0, 0, 0.2);
    }

    .nav-tabs .nav-link {
      color: #000;
      border: 2px solid transparent;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      padding: 10px 20px;
      font-weight: 600;
    }

    .nav-tabs .nav-link:hover {
      border-color: rgba(0, 0, 0, 0.1);
      background-color: #f8f9fa;
    }

    .nav-tabs .nav-link.active {
      color: #000;
      background-color: #fff;
      border-color: rgba(0, 0, 0, 0.2);
      border-bottom-color: #fff;
    }

    .card {
      border: 2px solid rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      background-color: #fff;
    }

    .card-body {
      padding: 20px;
    }

    .badge {
      background-color: #f8f9fa;
      color: #000;
      border: 1px solid rgba(0, 0, 0, 0.2);
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: 600;
    }

    .page-header {
      border-bottom: 2px solid rgba(0, 0, 0, 0.2);
      background: linear-gradient(to bottom, #ffffff, #f8f9fa);
      padding: 20px 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .page-header h2 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #000;
      margin: 0;
    }

    .page-header p {
      color: #000;
      margin: 5px 0 0 0;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
    }

    .btn-action {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .btn-view {
      background-color: #0d6efd;
      color: white;
    }

    .btn-view:hover {
      background-color: #0b5ed7;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background-color: #bb2d3b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .btn-action i {
      font-size: 18px;
      margin-left: 4px;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 0.8rem;
    }
  </style>
</head>

<body class="g-sidenav-show rtl bg-gray-100">
  <%- include('partials/aside') %>
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <%- include('partials/nav') %>

    <div class="container-fluid py-2">
      <!-- Header -->
      <div class="page-header">
        <h2 class="mb-0">
          <i class="material-symbols-rounded me-2" style="font-size: 28px; vertical-align: middle;">school</i>
          حضور وانصراف الطلاب
        </h2>
        <p class="text-sm">
          <%= new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
        </p>
      </div>

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="stats-card">
            <div class="stats-icon">
              <i class="material-symbols-rounded">check_circle</i>
            </div>
            <div class="stats-number" id="presentCount">0</div>
            <div class="stats-label">حاضر</div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="stats-card">
            <div class="stats-icon">
              <i class="material-symbols-rounded">schedule</i>
            </div>
            <div class="stats-number" id="lateCount">0</div>
            <div class="stats-label">متأخر</div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="stats-card">
            <div class="stats-icon">
              <i class="material-symbols-rounded">cancel</i>
            </div>
            <div class="stats-number" id="absentCount">0</div>
            <div class="stats-label">غائب</div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="stats-card">
            <div class="stats-icon">
              <i class="material-symbols-rounded">logout</i>
            </div>
            <div class="stats-number" id="departedCount">0</div>
            <div class="stats-label">منصرف</div>
          </div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="card filter-section">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-lg-3 col-md-6">
              <label class="filter-label">
                <i class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">calendar_today</i>
                التاريخ
              </label>
              <input type="date" class="form-control" id="filterDate" value="<%= new Date().toISOString().split('T')[0] %>">
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="filter-label">
                <i class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">class</i>
                الصف
              </label>
              <select class="form-select" id="filterClass">
                <option value="">جميع الصفوف</option>
              </select>
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="filter-label">
                <i class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">filter_list</i>
                الحالة
              </label>
              <select class="form-select" id="filterStatus">
                <option value="">جميع الحالات</option>
                <option value="Present">حاضر</option>
                <option value="Late">متأخر</option>
                <option value="Absent">غائب</option>
                <option value="departed">منصرف</option>
              </select>
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="filter-label">
                <i class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle;">search</i>
                بحث
              </label>
              <input type="text" class="form-control" id="searchStudent" placeholder="اسم الطالب أو الكود...">
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <button class="btn btn-primary me-2" onclick="applyFilters()">
                <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">filter_alt</i>
                تطبيق الفلاتر
              </button>
              <button class="btn btn-outline-dark me-2" onclick="resetFilters()">
                <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">refresh</i>
                إعادة تعيين
              </button>
              <button class="btn btn-primary float-start" onclick="exportToExcel()">
                <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">download</i>
                تصدير Excel
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="attendanceTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="present-tab" data-bs-toggle="tab" data-bs-target="#present" type="button">
            <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">check_circle</i>
            الحضور
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="absent-tab" data-bs-toggle="tab" data-bs-target="#absent" type="button">
            <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">cancel</i>
            الغياب
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="departed-tab" data-bs-toggle="tab" data-bs-target="#departed" type="button">
            <i class="material-symbols-rounded me-2" style="font-size: 18px; vertical-align: middle;">logout</i>
            الانصراف
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="attendanceTabContent">
        <!-- Present Students -->
        <div class="tab-pane fade show active" id="present" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-items-center mb-0" id="presentTable">
                  <thead>
                    <tr>
                      <th class="text-center">#</th>
                      <th>الطالب</th>
                      <th>الكود</th>
                      <th>الصف</th>
                      <th>وقت الحضور</th>
                      <th>الحالة</th>
                      <th>طريقة التحقق</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody id="presentTableBody">
                    <tr>
                      <td colspan="8" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Absent Students -->
        <div class="tab-pane fade" id="absent" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-items-center mb-0" id="absentTable">
                  <thead>
                    <tr>
                      <th class="text-center">#</th>
                      <th>الطالب</th>
                      <th>الكود</th>
                      <th>الصف</th>
                      <th>ولي الأمر</th>
                      <th>رقم الهاتف</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody id="absentTableBody">
                    <tr>
                      <td colspan="7" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Departed Students -->
        <div class="tab-pane fade" id="departed" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-items-center mb-0" id="departedTable">
                  <thead>
                    <tr>
                      <th class="text-center">#</th>
                      <th>الطالب</th>
                      <th>الكود</th>
                      <th>الصف</th>
                      <th>وقت الحضور</th>
                      <th>وقت الانصراف</th>
                      <th>المدة</th>
                      <th>الإجراءات</th>
                    </tr>
                  </thead>
                  <tbody id="departedTableBody">
                    <tr>
                      <td colspan="8" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Core JS - Load Bootstrap first -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    let allData = [];
    let filteredData = [];
    let currentTab = 'present';

    // Load classes for filter
    async function loadClasses() {
      try {
        const response = await axios.get('/admin/all-classes');
        const classes = response.data;
        const select = document.getElementById('filterClass');
        classes.forEach(cls => {
          const option = document.createElement('option');
          option.value = cls._id;
          option.textContent = cls.className || `${cls.academicLevel} - ${cls.section}`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading classes:', error);
      }
    }

    // Load attendance data with filters
    async function loadAttendanceData() {
      const date = document.getElementById('filterDate').value;
      const classId = document.getElementById('filterClass').value;
      const status = document.getElementById('filterStatus').value;
      const search = document.getElementById('searchStudent').value;
      
      // Build query params
      const params = new URLSearchParams({
        date: date,
        tab: currentTab
      });
      
      if (classId) params.append('classId', classId);
      if (status) params.append('status', status);
      if (search) params.append('search', search);

      try {
        const response = await axios.get(`/admin/student-attendance-dashboard-data?${params.toString()}`);
        allData = response.data.attendance || [];
        filteredData = [...allData];
        updateStatistics();
        renderTables();
      } catch (error) {
        console.error('Error loading attendance:', error);
        showNotification('حدث خطأ في تحميل البيانات', 'danger');
      }
    }

    // Update statistics
    function updateStatistics() {
      const present = filteredData.filter(a => (a.status === 'Present' || a.status === 'Late') && a.entryTime).length;
      const late = filteredData.filter(a => a.status === 'Late').length;
      const absent = filteredData.filter(a => a.status === 'Absent').length;
      const departed = filteredData.filter(a => a.exitTime).length;

      document.getElementById('presentCount').textContent = present;
      document.getElementById('lateCount').textContent = late;
      document.getElementById('absentCount').textContent = absent;
      document.getElementById('departedCount').textContent = departed;
    }

    // Render tables
    function renderTables() {
      renderPresentTable();
      renderAbsentTable();
      renderDepartedTable();
    }

    // Render present students
    function renderPresentTable() {
      const tbody = document.getElementById('presentTableBody');
      const present = filteredData.filter(a => (a.status === 'Present' || a.status === 'Late') && a.entryTime);

      if (present.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted">لا توجد بيانات</td></tr>';
        return;
      }

      tbody.innerHTML = present.map((att, index) => `
                <tr>
                    <td class="text-center">${index + 1}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-2" style="width: 32px; height: 32px; border-radius: 50%; background-color: #f8f9fa; border: 2px solid rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                                <span style="color: #000; font-weight: 600;">${att.student?.studentName?.charAt(0) || 'ط'}</span>
                            </div>
                            <span class="fw-bold">${att.student?.studentName || 'غير معروف'}</span>
                        </div>
                    </td>
                    <td><span class="badge">${att.student?.studentCode || 'N/A'}</span></td>
                    <td>${att.class?.className || 'غير محدد'}</td>
                    <td>
                        <i class="material-symbols-rounded me-1" style="font-size: 16px; vertical-align: middle;">schedule</i>
                        ${new Date(att.entryTime).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', timeZone: 'Africa/Cairo' })}
                    </td>
                    <td><span class="status-badge status-${att.status.toLowerCase()}">${getStatusText(att.status)}</span></td>
                    <td><i class="material-symbols-rounded me-1" style="font-size: 16px; vertical-align: middle;">fingerprint</i>${att.verifyMethod || 'Face Recognition'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view btn-sm" onclick="viewStudentDetails('${att.student?._id}')" title="عرض التفاصيل">
                                <i class="material-symbols-rounded">visibility</i>
                            </button>
                            <button class="btn-action btn-delete btn-sm" onclick="deleteAttendance('${att._id}', '${att.student?.studentName || 'هذا السجل'}')" title="حذف السجل">
                                <i class="material-symbols-rounded">delete</i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
    }

    // Render absent students
    function renderAbsentTable() {
      const tbody = document.getElementById('absentTableBody');
      const absent = filteredData.filter(a => a.status === 'Absent');

      if (absent.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">لا توجد بيانات</td></tr>';
        return;
      }

      tbody.innerHTML = absent.map((att, index) => `
                <tr>
                    <td class="text-center">${index + 1}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-2" style="width: 32px; height: 32px; border-radius: 50%; background-color: #f8f9fa; border: 2px solid rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                                <span style="color: #000; font-weight: 600;">${att.student?.studentName?.charAt(0) || 'ط'}</span>
                            </div>
                            <span class="fw-bold">${att.student?.studentName || 'غير معروف'}</span>
                        </div>
                    </td>
                    <td><span class="badge">${att.student?.studentCode || 'N/A'}</span></td>
                    <td>${att.class?.className || 'غير محدد'}</td>
                    <td>${att.student?.parentName || 'غير متوفر'}</td>
                    <td>${att.student?.parentPhone1 || 'غير متوفر'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view btn-sm" onclick="viewStudentDetails('${att.student?._id}')" title="عرض التفاصيل">
                                <i class="material-symbols-rounded">visibility</i>
                            </button>
                            <button class="btn-action btn-delete btn-sm" onclick="deleteAttendance('${att._id}', '${att.student?.studentName || 'هذا السجل'}')" title="حذف السجل">
                                <i class="material-symbols-rounded">delete</i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
    }

    // Render departed students
    function renderDepartedTable() {
      const tbody = document.getElementById('departedTableBody');
      const departed = filteredData.filter(a => a.exitTime);

      if (departed.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted">لا توجد بيانات</td></tr>';
        return;
      }

      tbody.innerHTML = departed.map((att, index) => {
        const duration = calculateDuration(att.entryTime, att.exitTime);
        return `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td>
                            <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-2" style="width: 32px; height: 32px; border-radius: 50%; background-color: #f8f9fa; border: 2px solid rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                                <span style="color: #000; font-weight: 600;">${att.student?.studentName?.charAt(0) || 'ط'}</span>
                            </div>
                                <span class="fw-bold">${att.student?.studentName || 'غير معروف'}</span>
                            </div>
                        </td>
                        <td><span class="badge">${att.student?.studentCode || 'N/A'}</span></td>
                        <td>${att.class?.className || 'غير محدد'}</td>
                        <td>
                            <i class="material-symbols-rounded me-1" style="font-size: 16px; vertical-align: middle;">login</i>
                            ${new Date(att.entryTime).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', timeZone: 'Africa/Cairo' })}
                        </td>
                        <td>
                            <i class="material-symbols-rounded me-1" style="font-size: 16px; vertical-align: middle;">logout</i>
                            ${new Date(att.exitTime).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', timeZone: 'Africa/Cairo' })}
                        </td>
                        <td><span class="badge">${duration}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view btn-sm" onclick="viewStudentDetails('${att.student?._id}')" title="عرض التفاصيل">
                                    <i class="material-symbols-rounded">visibility</i>
                                </button>
                                <button class="btn-action btn-delete btn-sm" onclick="deleteAttendance('${att._id}', '${att.student?.studentName || 'هذا السجل'}')" title="حذف السجل">
                                    <i class="material-symbols-rounded">delete</i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
      }).join('');
    }

    // Apply filters - reload data from API
    function applyFilters() {
      loadAttendanceData();
    }

    // Reset filters
    function resetFilters() {
      document.getElementById('filterClass').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('searchStudent').value = '';
      document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
      currentTab = 'present';
      // Reset tab to present
      const presentTab = document.getElementById('present-tab');
      if (presentTab) {
        const tab = new bootstrap.Tab(presentTab);
        tab.show();
      }
      loadAttendanceData();
    }

    // Handle tab change
    function handleTabChange(tabName) {
      currentTab = tabName;
      loadAttendanceData();
    }

    // Helper functions
    function getStatusText(status) {
      const statusMap = {
        'Present': 'حاضر',
        'Late': 'متأخر',
        'Absent': 'غائب',
        'Early-Leave': 'انصراف مبكر',
        'Permission': 'إذن'
      };
      return statusMap[status] || status;
    }

    function calculateDuration(entry, exit) {
      const diff = new Date(exit) - new Date(entry);
      const hours = Math.floor(diff / 3600000);
      const minutes = Math.floor((diff % 3600000) / 60000);
      return `${hours}س ${minutes}د`;
    }

    function viewStudentDetails(studentId) {
      window.location.href = `/admin/student-log-view/${studentId}`;
    }

    function contactParent(studentId) {
      // Implement contact parent functionality
      showNotification('سيتم التواصل مع ولي الأمر قريباً', 'info');
    }

    // Delete attendance record
    async function deleteAttendance(attendanceId, studentName) {
      if (!confirm(`هل أنت متأكد من حذف سجل الحضور للطالب "${studentName}"؟\n\n⚠️ تحذير: لا يمكن التراجع عن هذا الإجراء!`)) {
        return;
      }

      try {
        const response = await axios.delete(`/admin/attendance/student/${attendanceId}`);
        
        if (response.data.success) {
          // Reload data to refresh the table
          loadAttendanceData();
          showNotification('✅ تم حذف سجل الحضور بنجاح', 'success');
        } else {
          showNotification('❌ حدث خطأ أثناء حذف السجل', 'danger');
        }
      } catch (error) {
        console.error('Error deleting attendance:', error);
        if (error.response && error.response.status === 404) {
          showNotification('❌ لم يتم العثور على السجل', 'danger');
        } else if (error.response && error.response.status === 401) {
          showNotification('❌ غير مصرح لك بحذف هذا السجل', 'danger');
        } else {
          showNotification('❌ حدث خطأ أثناء حذف السجل: ' + (error.response?.data?.error || error.message), 'danger');
        }
      }
    }

    function exportToExcel() {
      const date = document.getElementById('filterDate').value;
      const classId = document.getElementById('filterClass').value;
      const status = document.getElementById('filterStatus').value;
      const search = document.getElementById('searchStudent').value;
      
      // Build query params
      const params = new URLSearchParams({
        date: date,
        tab: currentTab
      });
      
      if (classId) params.append('classId', classId);
      if (status) params.append('status', status);
      if (search) params.append('search', search);

      window.location.href = `/admin/export-student-attendance?${params.toString()}`;
    }

    function showNotification(message, type = 'success') {
      // Use your existing notification system
      alert(message);
    }

    // Event listeners
    document.getElementById('filterDate').addEventListener('change', loadAttendanceData);
    document.getElementById('searchStudent').addEventListener('input', debounce(applyFilters, 500));
    document.getElementById('filterClass').addEventListener('change', applyFilters);
    document.getElementById('filterStatus').addEventListener('change', applyFilters);

    // Tab event listeners
    const presentTab = document.getElementById('present-tab');
    const absentTab = document.getElementById('absent-tab');
    const departedTab = document.getElementById('departed-tab');

    if (presentTab) {
      presentTab.addEventListener('shown.bs.tab', () => handleTabChange('present'));
    }
    if (absentTab) {
      absentTab.addEventListener('shown.bs.tab', () => handleTabChange('absent'));
    }
    if (departedTab) {
      departedTab.addEventListener('shown.bs.tab', () => handleTabChange('departed'));
    }

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadClasses();
      loadAttendanceData();
    });
  </script>
</body>

</html>